


# WebSocketの接続状態とクローズコード

## 🔄 WebSocket API の `readyState`

WebSocket の接続状態を示す `readyState` プロパティは、以下のような数値定数を持ちます：

| 値 (`readyState`) | 定数名       | 説明 |
|-------------------|--------------|------|
| `0`               | `CONNECTING` | 接続中（確立前） |
| `1`               | `OPEN`       | 接続確立、通信可能 |
| `2`               | `CLOSING`    | 切断処理中 |
| `3`               | `CLOSED`     | 完全に切断済み |

```ts
const ws = new WebSocket("wss://example.com/socket");
if (ws.readyState === WebSocket.OPEN) {
  ws.send("Hello");
}
```


## 📋 WebSocketで定義されているステータスコード（Defined Status Codes）

### 🔁 クライアント・サーバー双方での使用

Defined Status Codes は、**クライアント側・サーバー側の両方で使用・解釈されることを前提としたコード**です。

| 使用側 | 目的 |
|--------|------|
| クライアント | `ws.close(code, reason)` を用いて接続終了時に送信したり、`onclose` イベントで受信側としてコードを確認する |
| サーバー | WebSocket 接続を終了する際に、`code` と `reason` を指定して切断処理を行う |

例：
```ts
// クライアント側
ws.close(1000, "正常終了");

// サーバー側（Node.js など）
socket.close(1008, "ポリシー違反");
```

> なお、`1005`, `1006`, `1015` など一部のコードはアプリケーションから送信することはできず、内部処理専用として予約されています。

接続の終了理由を示すステータスコードが RFC 6455 などで定義されています：

| コード | 名前 | 意味 |
|--------|------|------|
| `1000` | Normal Closure | 正常な切断 |
| `1001` | Going Away | サーバーシャットダウンやページ遷移 |
| `1002` | Protocol Error | プロトコル違反 |
| `1003` | Unsupported Data | サポート外のデータ |
| `1005` | No Status Received | ステータスコード未受信（内部用） |
| `1006` | Abnormal Closure | 異常終了（アプリからは指定不可） |
| `1007` | Invalid Payload Data | 無効なデータ |
| `1008` | Policy Violation | ポリシー違反 |
| `1009` | Message Too Big | メッセージが大きすぎる |
| `1010` | Mandatory Ext. | 必須拡張が使用不可 |
| `1011` | Internal Error | サーバー内部エラー |
| `1015` | TLS Handshake | TLSハンドシェイク失敗（内部用） |


## ❌ `.close()` による接続終了と Close Code の使い方

WebSocket を明示的に閉じる場合は、コードと理由を渡せます。

```ts
ws.close(1000, "Normal closure");
```

- コードは `1000`～`4999` の範囲
- 理由は最大123バイトの文字列
- `1005`, `1006`, `1015` は JavaScript から送信不可（内部用）


## 約済みのステータスコード範囲

|範囲|説明|
|---|---|
|0～999|0～999の範囲のステータスコードは使用されません。|
|1000～2999|1000～2999の範囲のステータスコードは、このプロトコル、将来の改訂版、および永続的で容易に利用可能な公開仕様で規定される拡張によって定義されるために予約されています。|
|3000～3999|3000～3999の範囲のステータスコードは、ライブラリ、フレームワーク、およびアプリケーションで使用するために予約されています。これらのステータスコードは、IANAに直接登録されています。これらのコードの解釈は、このプロトコルでは定義されていません。|
|4000～4999|4000～4999の範囲のステータスコードは、プライベート使用のために予約されているため、登録できません。これらのコードは、WebSocketアプリケーション間で事前に合意することで使用できます。|

## 🧭 まとめ

| 区分 | 内容 |
|------|------|
| `readyState` | WebSocketの接続状態（0〜3） |
| Defined Status Codes | RFCで定義された切断理由 |
| `.close()`コード | アプリ側で明示的に使う終了コード（3000〜独自定義も可能） |